/*!
 * /*:
 * @target MZ
 * @plugindesc Movement, Skin
 * @author rmalizia44@gmail.com
 * @url https://rmalizia44.itch.io/
 * @help
 *
 * ‚öîÔ∏è MMORPG Maker Plugin 0.9.1
 *
 * Maps with <Sync> added to their note field allow players to interact
 * and see each other, creating shared online areas. Maps without <Sync>
 * in the note field are treated as solo instances for each player.
 *
 * Followers are also synced, allowing players to see each other's followers
 * in real time. This functionality can even support pet systems, giving
 * developers more creative options for gameplay.
 *
 * üíñ Special Thanks to Our Patrons!
 *
 * A huge shout-out to everyone supporting the project through Patreon!
 * Your contributions help keep this plugin alive and growing. Here are
 * the amazing supporters from each tier:
 *
 * üèÜ Champion Tier
 *
 * - Emerson
 * - James Shmo
 *
 * üåü Legendary Tier
 *
 * - Alexis Naboulet
 * - Ansgar
 * - David Cuellar
 * - Zufran
 *
 * ‚ú® Epic Tier
 *
 * - Lupilo
 * - Mr.Timbaba
 *
 *
 * @base MMORPG_Client
 * @orderAfter MMORPG_Client
 *
 * @base MMORPG_Actors
 * @orderAfter MMORPG_Actors
 *
 * @param showLoginName
 * @text Show Login Name
 * @type boolean
 * @desc Show User Login as Name
 * @default false
 *
 */(()=>{"use strict";const e=window;function t(t){return"number"==typeof t&&(!!Number.isSafeInteger(t)&&(!(t<1)&&!(e.$dataMapInfos&&t>=e.$dataMapInfos.length)))}const r=window.client;const a=function(...e){},o=e.Game_Actor.prototype.setCharacterImage;e.Game_Actor.prototype.setCharacterImage=function(t,r){const a=this._characterName,s=this._characterIndex;o.call(this,t,r),e.$gameParty.battleMembers().includes(this)&&(a===this._characterName&&s===this._characterIndex||(e.$gamePlayer.refresh(),e.$gamePlayer.publishSkins()))};const s=e.Game_Actor.prototype.onChangeName;e.Game_Actor.prototype.onChangeName=function(){s.call(this),this.isLeader()&&e.$gamePlayer.publishInfo()};const n=e.Game_Actor.prototype.onChangeProfile;e.Game_Actor.prototype.onChangeProfile=function(){n.call(this),this.isLeader()&&e.$gamePlayer.publishInfo()};const i=e.Game_Actor.prototype.onChangeFace;e.Game_Actor.prototype.onChangeFace=function(){i.call(this),this.isLeader()&&e.$gamePlayer.publishInfo()};const p=e.Game_Actor.prototype.onChangeClassExp;e.Game_Actor.prototype.onChangeClassExp=function(){p.call(this),this.isLeader()&&e.$gamePlayer.publishInfo()},e.Game_CharacterBase.prototype.remote=function(){return""},e.Game_CharacterBase.prototype.packChar=function(){return{x:this.x,y:this.y,d:this.direction(),s:this.realMoveSpeed()}},e.Game_CharacterBase.prototype.packSkin=function(){return{n:this.characterName(),i:this.characterIndex()}},e.Game_CharacterBase.prototype.setChar=function(t){const{x:r,y:a,d:o,s,m:n,j:i}=t;if("number"!=typeof r)return console.error("invalid x"),!1;if("number"!=typeof a)return console.error("invalid y"),!1;if("number"!=typeof o)return console.error("invalid d"),!1;if("number"!=typeof s)return console.error("invalid s"),!1;if(this.setMoveSpeed(s),this.setDirection(o),e.SceneManager._scene instanceof e.Scene_Map){if(i)return this.jump(r-this.x,a-this.y),!0;const t=e.$gameMap.distance(this._realX,this._realY,r,a);if(n&&t<3)return this._x=r,this._y=a,!0}return this.locate(r,a),!0},e.Game_CharacterBase.prototype.setSkin=function(e){const{n:t,i:r}=e;return"string"!=typeof t?(console.error("invalid n"),!1):"number"!=typeof r?(console.error("invalid i"),!1):(this.setImage(t,r),!0)};class c extends e.Game_Character{_leader;constructor(e){super(),this._leader=e}realMoveSpeed(){return this._leader.realMoveSpeed()}update(){super.update(),this.setMoveSpeed(this._leader.realMoveSpeed()),this.setOpacity(this._leader.opacity()),this.setBlendMode(this._leader.blendMode()),this.setWalkAnime(this._leader.hasWalkAnime()),this.setStepAnime(this._leader.hasStepAnime()),this.setDirectionFix(this._leader.isDirectionFixed()),this.setTransparent(this._leader.isTransparent())}}class m extends e.Game_Character{_remote;_followers=new Array;faceName="";faceIndex=0;name="";level=0;className="";nickname="";profile="";constructor(t){super(),this._remote=t;for(let t=1;t<e.$gameParty.maxBattleMembers();++t)this._followers.push(new c(this))}remote(){return this._remote}followers(){return this._followers}isTriggerIn(e){return!1}update(){super.update();for(const e of this._followers)e.update()}party(){return[this].concat(this._followers)}setChars(e){const t=this.party();for(let r=0;r<e.length;++r){const a=t[r];if(!a)return!1;if(!a.setChar(e[r]))return!1}return!0}setSkins(e){const t=this.party();for(let r=0;r<e.length;++r){const a=t[r];if(!a)return!1;if(!a.setSkin(e[r]))return!1}return!0}}e.Game_Map.prototype.remotes=function(){return this._remotes||(this._remotes=new Map),this._remotes},e.Game_Map.prototype.clearRemotes=function(){this.remotes().clear()},e.Game_Map.prototype.hasRemote=function(e){return this.remotes().has(e)},e.Game_Map.prototype.getRemote=function(e){return this.remotes().get(e)},e.Game_Map.prototype.reqRemote=function(e){let t=this.getRemote(e);return t||(t=new m(e),this.remotes().set(e,t)),t},e.Game_Map.prototype.delRemote=function(e){this.remotes().delete(e)},e.Game_Map.prototype.syncType=function(){const t=e.$dataMap;if(!t)return"";const r=Object.keys(t.meta);return this.syncFind(r)},e.Game_Map.prototype.syncName=function(){return e.$gameMap.mapId().toString()},e.Game_Map.prototype.syncFind=function(e){return e.some((e=>"sync"===e.toLowerCase()))?"sync":""};const l=e.Game_Map.prototype.setup;e.Game_Map.prototype.setup=function(e){l.call(this,e),this.clearRemotes()};const h=e.Game_Map.prototype.update;function f(e,t){return e.length==t.length&&e.every(((e,r)=>e==t[r]))}e.Game_Map.prototype.update=function(e){h.call(this,e),this.remotes().forEach((e=>e.update()))},e.Game_Party.prototype.leaderName=function(){return this.leader()?._name||""};const u=e.Game_Party.prototype.addActor;e.Game_Party.prototype.addActor=function(t){const r=Array.from(this.battleMembers());u.call(this,t);f(r,Array.from(this.battleMembers()))||e.$gamePlayer.publishSkins()};const y=e.Game_Party.prototype.removeActor;e.Game_Party.prototype.removeActor=function(t){const r=Array.from(this.battleMembers());y.call(this,t);f(r,Array.from(this.battleMembers()))||e.$gamePlayer.publishSkins()};const d=e.Game_Party.prototype.swapOrder;e.Game_Party.prototype.swapOrder=function(t,r){const a=Array.from(this.battleMembers());d.call(this,t,r);f(a,Array.from(this.battleMembers()))||e.$gamePlayer.publishSkins()},e.Game_Player.prototype.partyChars=function(){let t=[this];return e.$dataSystem.optFollowers&&(t=t.concat(this.followers().visibleFollowers())),t},e.Game_Player.prototype.partyActors=function(){let t=[e.$gameParty.leader()];return e.$dataSystem.optFollowers&&(t=t.concat(this.followers().visibleFollowers().map((e=>e.actor())))),t},e.Game_Player.prototype.getInfo=function(){const t=e.$gameParty.leader();return[t.faceName(),t.faceIndex(),t.name(),t.level,t.currentClass().name,t.profile(),this.partyActors().map((e=>e?.actor()?.meta))]},e.Game_Player.prototype.packChars=function(){return this.partyChars().map((e=>e.packChar()))},e.Game_Player.prototype.packSkins=function(){return this.partyChars().map((e=>e.packSkin()))},e.Game_Player.prototype.sendInfo=function(t){r.sendto(t,"info",e.$gameMap.mapId(),...this.getInfo())},e.Game_Player.prototype.sendChars=function(t){r.sendto(t,"char",e.$gameMap.mapId(),this.packChars())},e.Game_Player.prototype.sendSkins=function(t){r.sendto(t,"skin",e.$gameMap.mapId(),this.packSkins())},e.Game_Player.prototype.publishSkins=function(){this._subscribed&&r.publish(!1,"map","skin",e.$gameMap.mapId(),this.packSkins())},e.Game_Player.prototype.publishInfo=function(){this._subscribed&&r.publish(!1,"map","info",e.$gameMap.mapId(),...this.getInfo())},e.Game_Player.prototype.publishMoves=function(){if(!this._subscribed)return;const t=this.packChars().map((e=>({m:!0,...e})));r.publish(!1,"map","char",e.$gameMap.mapId(),t)},e.Game_Player.prototype.publishJumps=function(){if(!this._subscribed)return;const t=this.packChars().map((e=>({j:!0,...e})));r.publish(!1,"map","char",e.$gameMap.mapId(),t)},e.Game_Player.prototype.savePosition=function(){r.save(!1,"char",{map:e.$gameMap.mapId(),x:this.x,y:this.y})};const _=e.Game_Player.prototype.performTransfer;e.Game_Player.prototype.performTransfer=function(){_.call(this);const t=e.$gameMap.syncType(),a=e.$gameMap.syncName();t&&a?(r.subscribe("map",t+a,e.$gameParty.leaderName()),this._subscribed=!0):(r.subscribe("map",null),this._subscribed=!1),this.savePosition()};const g=e.Game_Player.prototype.moveStraight;e.Game_Player.prototype.moveStraight=function(e){const t=this.x,r=this.y,a=this.direction();g.call(this,e);const o=this.x,s=this.y,n=this.direction();t===o&&r===s&&a===n||this.publishMoves(),t===o&&r===s||this.savePosition()};const M=e.Game_Player.prototype.moveDiagonally;e.Game_Player.prototype.moveDiagonally=function(e,t){const r=this.x,a=this.y,o=this.direction();M.call(this,e,t);const s=this.x,n=this.y,i=this.direction();r===s&&a===n&&o===i||this.publishMoves(),r===s&&a===n||this.savePosition()};const b=e.Game_Player.prototype.jump;function v(e,t,r){a("invalid interaction:",e,t,r)}function G(t,r){const o=window._interaction;if(!o||o.size<1)return void a("no interaction registered");if(e.$gameMessage.isBusy())return;const s=Array.from(o.keys()).slice(0,4);e.$gameMessage.setFaceImage(r.faceName,r.faceIndex),e.$gameMessage.setSpeakerName("true"==e.PluginManager.parameters("MMORPG_Characters").showLoginName?t:r.name),e.$gameMessage.add(`${e.TextManager.level} ${r.level}`),e.$gameMessage.add(r.className),e.$gameMessage.add(r.profile),e.$gameMessage.setChoices(s,0,-2),e.$gameMessage.setChoiceCallback((e=>{!function(e){if(!window._interaction)return v.bind(null,e);return window._interaction.get(e)||v.bind(null,e)}(s[e])(t,r.name)}))}e.Game_Player.prototype.jump=function(e,t){b.call(this,e,t),this.publishJumps(),this.savePosition()};const P=e.Game_Player.prototype.startMapEvent;e.Game_Player.prototype.startMapEvent=function(t,r,a,o){if(P.call(this,t,r,a,o),!e.$gameMap.isEventRunning())for(const[o,s]of e.$gameMap.remotes())if(s.pos(t,r)&&a.includes(0))return G(o,s)},e.Sprite_Character.prototype.remote=function(){return this._character.remote()};const S=window.mz3d;class $ extends e.Sprite_Character{_mz3d;constructor(e){super(e),S&&(this._mz3d=S.createCharacterFor(e,0))}destroy(e){return S&&this._mz3d&&(S.characters.indexOf(this._mz3d)>=0&&(delete this._mz3d.char.mv3d_sprite,this._mz3d.dispose(!1,!0)),this._mz3d=void 0),super.destroy(e)}}class C extends ${_followers;constructor(e,t){super(e),this._followers=t}followers(){return this._followers}}e.Spriteset_Map.prototype.remotes=function(){return this._remotes||(this._remotes=new Map),this._remotes},e.Spriteset_Map.prototype.clearRemotes=function(){for(const[e,t]of this.remotes())t.destroy();this.remotes().clear()},e.Spriteset_Map.prototype.hasRemote=function(e){return this.remotes().has(e)},e.Spriteset_Map.prototype.reqRemote=function(t){let r=this.remotes().get(t);if(!r){const a=e.$gameMap.reqRemote(t),o=Array.from(a.followers()).reverse().map((e=>new $(e)));r=new C(a,o);for(const e of r.followers())this._tilemap.addChild(e);this._characterSprites.push(r),this._tilemap.addChild(r),this.remotes().set(t,r)}return r},e.Spriteset_Map.prototype.delRemote=function(e){const t=this.remotes().get(e);if(t){t.destroy();for(const e of t.followers())e.destroy()}this.remotes().delete(e)};const w=e.Spriteset_Map.prototype.createCharacters;e.Spriteset_Map.prototype.createCharacters=function(){w.call(this),this.clearRemotes();for(const[t,r]of e.$gameMap.remotes())this.reqRemote(t)};const k=e.Spriteset_Map.prototype.hideCharacters;e.Spriteset_Map.prototype.hideCharacters=function(){k.call(this);for(const[e,t]of this.remotes()){t.hide();for(const e of t.followers())e.hide()}};const I=e.Spriteset_Map.prototype.findTargetSprite;e.Spriteset_Map.prototype.findTargetSprite=function(e){for(const[t,r]of this.remotes())if(r.checkCharacter(e))return r;return I.call(this,e)},r.start(!1,"char",(t=>{const{map:r,x:o,y:s}=t;if("number"!=typeof r||"number"!=typeof o||"number"!=typeof s)return a("no coords");e.$gamePlayer.reserveTransfer(r,o,s,2,0)})),r.react(e.Scene_Base,"map","+",((t,a)=>{r.sendto(a,"whois"),e.$gamePlayer.sendInfo(a),e.$gamePlayer.sendChars(a),e.$gamePlayer.sendSkins(a)})),r.react(e.Scene_Base,"map","-",((t,r)=>{t instanceof e.Scene_Map&&t._spriteset.delRemote(r),e.$gameMap.delRemote(r)})),r.react(e.Scene_Base,"@","whois",((t,r)=>{e.$gamePlayer.sendInfo(r),e.$gamePlayer.sendChars(r),e.$gamePlayer.sendSkins(r)})),r.react(e.Scene_Base,["@","map"],"info",((a,o,s,n,i,p,c,m,l,h)=>{if(!t(s))return r.report(o,"info invalid map");if("string"!=typeof n)return r.report(o,"info invalid faceName");if("number"!=typeof i||!Number.isSafeInteger(i))return r.report(o,"info invalid faceIndex");if("string"!=typeof p)return r.report(o,"info invalid name");if("number"!=typeof c||!Number.isSafeInteger(c))return r.report(o,"info invalid level");if("string"!=typeof m)return r.report(o,"info invalid className");if("string"!=typeof l)return r.report(o,"info invalid profile");const f=e.$gameMap.reqRemote(o);f.faceName=n,f.faceIndex=i,f.name=p,f.level=c,f.className=m,f.profile=l})),r.react(e.Scene_Base,["@","map"],"char",((a,o,s,n)=>{if(!t(s))return r.report(o,"char invalid map");if(e.$gameMap.mapId()!=s)return;if(!function(e){return Array.isArray(e)&&e.every((e=>!!e&&"object"==typeof e))}(n))return r.report(o,"char invalid chars");const i=e.$gameMap.reqRemote(o);return i?i.setChars(n)?void 0:r.report(o,"char invalid data"):r.sendto(o,"whois")})),r.react(e.Scene_Base,["@","map"],"skin",((a,o,s,n)=>{if(!t(s))return r.report(o,"skin invalid map");if(e.$gameMap.mapId()!=s)return;if(!function(e){return Array.isArray(e)&&e.every((e=>!!e&&"object"==typeof e))}(n))return r.report(o,"skin invalid skins");const i=e.$gameMap.reqRemote(o);return i?i.setSkins(n)?void(a instanceof e.Scene_Map&&a._spriteset.reqRemote(o)):r.report(o,"skin invalid data"):r.sendto(o,"whois")}))})();