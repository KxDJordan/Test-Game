/*!
 * /*:
 * @target MZ
 * @plugindesc Core Functionality
 * @author rmalizia44@gmail.com
 * @url https://rmalizia44.itch.io/
 * @help
 *
 * âš”ï¸ MMORPG Maker Plugin 0.9.1
 *
 * This plugin is the foundation for all the others; it is responsible
 * for communicating with the game server.
 *
 * ðŸ’– Special Thanks to Our Patrons!
 *
 * A huge shout-out to everyone supporting the project through Patreon!
 * Your contributions help keep this plugin alive and growing. Here are
 * the amazing supporters from each tier:
 *
 * ðŸ† Champion Tier
 *
 * - Emerson
 * - James Shmo
 *
 * ðŸŒŸ Legendary Tier
 *
 * - Alexis Naboulet
 * - Ansgar
 * - David Cuellar
 * - Zufran
 *
 * âœ¨ Epic Tier
 *
 * - Lupilo
 * - Mr.Timbaba
 *
 *
 * @param address
 * @text Address
 * @type string
 * @desc Server Address with Port
 * @default localhost:7070
 *
 * @param loginImage
 * @text Login Image
 * @type file[]
 * @desc Login Screen Images
 * @default ["img/battlebacks1/Clouds"]
 *
 * @param ssl
 * @text Use SSL
 * @type boolean
 * @desc Use SSL with Server Requests
 * @default false
 *
 */(()=>{"use strict";const t=window;function e(t){return"".concat(t<0?"-":"","0x").concat(Math.abs(t).toString(16).padStart(2,"0"))}var i,n=function(t,e){this.type=t,this.data=e},r=(i=function(t,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},i(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),s=function(t){function e(i){var n=t.call(this,i)||this,r=Object.create(e.prototype);return Object.setPrototypeOf(n,r),Object.defineProperty(n,"name",{configurable:!0,enumerable:!1,value:e.name}),n}return r(e,t),e}(Error),o=4294967295;function a(t,e,i){var n=Math.floor(i/4294967296),r=i;t.setUint32(e,n),t.setUint32(e+4,r)}function h(t,e){return 4294967296*t.getInt32(e)+t.getUint32(e+4)}var c={type:-1,encode:function(t){var e,i,n,r;return t instanceof Date?function(t){var e,i=t.sec,n=t.nsec;if(i>=0&&n>=0&&i<=17179869183){if(0===n&&i<=4294967295){var r=new Uint8Array(4);return(e=new DataView(r.buffer)).setUint32(0,i),r}var s=i/4294967296,o=4294967295&i;return r=new Uint8Array(8),(e=new DataView(r.buffer)).setUint32(0,n<<2|3&s),e.setUint32(4,o),r}return r=new Uint8Array(12),(e=new DataView(r.buffer)).setUint32(0,n),a(e,4,i),r}((e=t.getTime(),i=Math.floor(e/1e3),n=1e6*(e-1e3*i),r=Math.floor(n/1e9),{sec:i+r,nsec:n-1e9*r})):null},decode:function(t){var e=function(t){var e=new DataView(t.buffer,t.byteOffset,t.byteLength);switch(t.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:var i=e.getUint32(0);return{sec:4294967296*(3&i)+e.getUint32(4),nsec:i>>>2};case 12:return{sec:h(e,4),nsec:e.getUint32(0)};default:throw new s("Unrecognized data size for timestamp (expected 4, 8, or 12): ".concat(t.length))}}(t);return new Date(1e3*e.sec+e.nsec/1e6)}},u=function(){function t(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(c)}return t.prototype.register=function(t){var e=t.type,i=t.encode,n=t.decode;if(e>=0)this.encoders[e]=i,this.decoders[e]=n;else{var r=1+e;this.builtInEncoders[r]=i,this.builtInDecoders[r]=n}},t.prototype.tryToEncode=function(t,e){for(var i=0;i<this.builtInEncoders.length;i++){if(null!=(r=this.builtInEncoders[i]))if(null!=(s=r(t,e)))return new n(-1-i,s)}for(i=0;i<this.encoders.length;i++){var r,s;if(null!=(r=this.encoders[i]))if(null!=(s=r(t,e)))return new n(i,s)}return t instanceof n?t:null},t.prototype.decode=function(t,e,i){var r=e<0?this.builtInDecoders[-1-e]:this.decoders[e];return r?r(t,e,i):new n(e,t)},t.defaultCodec=new t,t}();var l=new TextEncoder;function f(t,e,i){t.length>50?function(t,e,i){l.encodeInto(t,e.subarray(i))}(t,e,i):function(t,e,i){for(var n=t.length,r=i,s=0;s<n;){var o=t.charCodeAt(s++);if(4294967168&o){if(4294965248&o){if(o>=55296&&o<=56319&&s<n){var a=t.charCodeAt(s);56320==(64512&a)&&(++s,o=((1023&o)<<10)+(1023&a)+65536)}4294901760&o?(e[r++]=o>>18&7|240,e[r++]=o>>12&63|128,e[r++]=o>>6&63|128):(e[r++]=o>>12&15|224,e[r++]=o>>6&63|128)}else e[r++]=o>>6&31|192;e[r++]=63&o|128}else e[r++]=o}}(t,e,i)}function p(t,e,i){for(var n=e,r=n+i,s=[],o="";n<r;){var a=t[n++];if(128&a)if(192==(224&a)){var h=63&t[n++];s.push((31&a)<<6|h)}else if(224==(240&a)){h=63&t[n++];var c=63&t[n++];s.push((31&a)<<12|h<<6|c)}else if(240==(248&a)){var u=(7&a)<<18|(h=63&t[n++])<<12|(c=63&t[n++])<<6|63&t[n++];u>65535&&(u-=65536,s.push(u>>>10&1023|55296),u=56320|1023&u),s.push(u)}else s.push(a);else s.push(a);s.length>=4096&&(o+=String.fromCharCode.apply(String,s),s.length=0)}return s.length>0&&(o+=String.fromCharCode.apply(String,s)),o}var d=new TextDecoder;function y(t,e,i){return i>200?function(t,e,i){var n=t.subarray(e,e+i);return d.decode(n)}(t,e,i):p(t,e,i)}function w(t){return t instanceof Uint8Array?t:ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t instanceof ArrayBuffer?new Uint8Array(t):Uint8Array.from(t)}var g=function(){function t(t,e){void 0===t&&(t=16),void 0===e&&(e=16),this.maxKeyLength=t,this.maxLengthPerKey=e,this.hit=0,this.miss=0,this.caches=[];for(var i=0;i<this.maxKeyLength;i++)this.caches.push([])}return t.prototype.canBeCached=function(t){return t>0&&t<=this.maxKeyLength},t.prototype.find=function(t,e,i){t:for(var n=0,r=this.caches[i-1];n<r.length;n++){for(var s=r[n],o=s.bytes,a=0;a<i;a++)if(o[a]!==t[e+a])continue t;return s.str}return null},t.prototype.store=function(t,e){var i=this.caches[t.length-1],n={bytes:t,str:e};i.length>=this.maxLengthPerKey?i[Math.random()*i.length|0]=n:i.push(n)},t.prototype.decode=function(t,e,i){var n=this.find(t,e,i);if(null!=n)return this.hit++,n;this.miss++;var r=p(t,e,i),s=Uint8Array.prototype.slice.call(t,e,e+i);return this.store(s,r),r},t}(),v=function(t,e,i,n){return new(i||(i=Promise))((function(r,s){function o(t){try{h(n.next(t))}catch(t){s(t)}}function a(t){try{h(n.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((n=n.apply(t,e||[])).next())}))},b=function(t,e){var i,n,r,s,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(h){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(i=1,n&&(r=2&a[0]?n.return:a[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,a[1])).done)return r;switch(n=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){o.label=a[1];break}if(6===a[0]&&o.label<r[1]){o.label=r[1],r=a;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(a);break}r[2]&&o.ops.pop(),o.trys.pop();continue}a=e.call(t,o)}catch(t){a=[6,t],n=0}finally{i=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,h])}}},m=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,i=t[Symbol.asyncIterator];return i?i.call(t):(t="function"==typeof __values?__values(t):t[Symbol.iterator](),e={},n("next"),n("throw"),n("return"),e[Symbol.asyncIterator]=function(){return this},e);function n(i){e[i]=t[i]&&function(e){return new Promise((function(n,r){(function(t,e,i,n){Promise.resolve(n).then((function(e){t({value:e,done:i})}),e)})(n,r,(e=t[i](e)).done,e.value)}))}}},U=function(t){return this instanceof U?(this.v=t,this):new U(t)},S=function(t,e,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,r=i.apply(t,e||[]),s=[];return n={},o("next"),o("throw"),o("return"),n[Symbol.asyncIterator]=function(){return this},n;function o(t){r[t]&&(n[t]=function(e){return new Promise((function(i,n){s.push([t,e,i,n])>1||a(t,e)}))})}function a(t,e){try{(i=r[t](e)).value instanceof U?Promise.resolve(i.value.v).then(h,c):u(s[0][2],i)}catch(t){u(s[0][3],t)}var i}function h(t){a("next",t)}function c(t){a("throw",t)}function u(t,e){t(e),s.shift(),s.length&&a(s[0][0],s[0][1])}},B="array",_="map_key",x=new DataView(new ArrayBuffer(0)),I=new Uint8Array(x.buffer);try{x.getInt8(0)}catch(t){if(!(t instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}var E=RangeError,A=new E("Insufficient data"),k=new g,T=function(){function t(t){var e,i,n,r,s,a,h;this.totalPos=0,this.pos=0,this.view=x,this.bytes=I,this.headByte=-1,this.stack=[],this.extensionCodec=null!==(e=null==t?void 0:t.extensionCodec)&&void 0!==e?e:u.defaultCodec,this.context=null==t?void 0:t.context,this.useBigInt64=null!==(i=null==t?void 0:t.useBigInt64)&&void 0!==i&&i,this.maxStrLength=null!==(n=null==t?void 0:t.maxStrLength)&&void 0!==n?n:o,this.maxBinLength=null!==(r=null==t?void 0:t.maxBinLength)&&void 0!==r?r:o,this.maxArrayLength=null!==(s=null==t?void 0:t.maxArrayLength)&&void 0!==s?s:o,this.maxMapLength=null!==(a=null==t?void 0:t.maxMapLength)&&void 0!==a?a:o,this.maxExtLength=null!==(h=null==t?void 0:t.maxExtLength)&&void 0!==h?h:o,this.keyDecoder=void 0!==(null==t?void 0:t.keyDecoder)?t.keyDecoder:k}return t.prototype.reinitializeState=function(){this.totalPos=0,this.headByte=-1,this.stack.length=0},t.prototype.setBuffer=function(t){this.bytes=w(t),this.view=function(t){if(t instanceof ArrayBuffer)return new DataView(t);var e=w(t);return new DataView(e.buffer,e.byteOffset,e.byteLength)}(this.bytes),this.pos=0},t.prototype.appendBuffer=function(t){if(-1!==this.headByte||this.hasRemaining(1)){var e=this.bytes.subarray(this.pos),i=w(t),n=new Uint8Array(e.length+i.length);n.set(e),n.set(i,e.length),this.setBuffer(n)}else this.setBuffer(t)},t.prototype.hasRemaining=function(t){return this.view.byteLength-this.pos>=t},t.prototype.createExtraByteError=function(t){var e=this.view,i=this.pos;return new RangeError("Extra ".concat(e.byteLength-i," of ").concat(e.byteLength," byte(s) found at buffer[").concat(t,"]"))},t.prototype.decode=function(t){this.reinitializeState(),this.setBuffer(t);var e=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return e},t.prototype.decodeMulti=function(t){return b(this,(function(e){switch(e.label){case 0:this.reinitializeState(),this.setBuffer(t),e.label=1;case 1:return this.hasRemaining(1)?[4,this.doDecodeSync()]:[3,3];case 2:return e.sent(),[3,1];case 3:return[2]}}))},t.prototype.decodeAsync=function(t){var i,n,r,s,o,a,h;return v(this,void 0,void 0,(function(){var c,u,l,f,p,d,y,w;return b(this,(function(g){switch(g.label){case 0:c=!1,g.label=1;case 1:g.trys.push([1,6,7,12]),i=!0,n=m(t),g.label=2;case 2:return[4,n.next()];case 3:if(r=g.sent(),s=r.done)return[3,5];h=r.value,i=!1;try{if(l=h,c)throw this.createExtraByteError(this.totalPos);this.appendBuffer(l);try{u=this.doDecodeSync(),c=!0}catch(t){if(!(t instanceof E))throw t}this.totalPos+=this.pos}finally{i=!0}g.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return f=g.sent(),o={error:f},[3,12];case 7:return g.trys.push([7,,10,11]),i||s||!(a=n.return)?[3,9]:[4,a.call(n)];case 8:g.sent(),g.label=9;case 9:return[3,11];case 10:if(o)throw o.error;return[7];case 11:return[7];case 12:if(c){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,u]}throw d=(p=this).headByte,y=p.pos,w=p.totalPos,new RangeError("Insufficient data in parsing ".concat(e(d)," at ").concat(w," (").concat(y," in the current buffer)"))}}))}))},t.prototype.decodeArrayStream=function(t){return this.decodeMultiAsync(t,!0)},t.prototype.decodeStream=function(t){return this.decodeMultiAsync(t,!1)},t.prototype.decodeMultiAsync=function(t,e){return S(this,arguments,(function(){var i,n,r,s,o,a,h,c,u,l,f,p;return b(this,(function(d){switch(d.label){case 0:i=e,n=-1,d.label=1;case 1:d.trys.push([1,15,16,21]),r=!0,s=m(t),d.label=2;case 2:return[4,U(s.next())];case 3:if(o=d.sent(),u=o.done)return[3,14];p=o.value,r=!1,d.label=4;case 4:if(d.trys.push([4,,12,13]),a=p,e&&0===n)throw this.createExtraByteError(this.totalPos);this.appendBuffer(a),i&&(n=this.readArraySize(),i=!1,this.complete()),d.label=5;case 5:d.trys.push([5,10,,11]),d.label=6;case 6:return[4,U(this.doDecodeSync())];case 7:return[4,d.sent()];case 8:return d.sent(),0==--n?[3,9]:[3,6];case 9:return[3,11];case 10:if(!((h=d.sent())instanceof E))throw h;return[3,11];case 11:return this.totalPos+=this.pos,[3,13];case 12:return r=!0,[7];case 13:return[3,2];case 14:return[3,21];case 15:return c=d.sent(),l={error:c},[3,21];case 16:return d.trys.push([16,,19,20]),r||u||!(f=s.return)?[3,18]:[4,U(f.call(s))];case 17:d.sent(),d.label=18;case 18:return[3,20];case 19:if(l)throw l.error;return[7];case 20:return[7];case 21:return[2]}}))}))},t.prototype.doDecodeSync=function(){t:for(;;){var t=this.readHeadByte(),i=void 0;if(t>=224)i=t-256;else if(t<192)if(t<128)i=t;else if(t<144){if(0!==(r=t-128)){this.pushMapState(r),this.complete();continue t}i={}}else if(t<160){if(0!==(r=t-144)){this.pushArrayState(r),this.complete();continue t}i=[]}else{var n=t-160;i=this.decodeUtf8String(n,0)}else if(192===t)i=null;else if(194===t)i=!1;else if(195===t)i=!0;else if(202===t)i=this.readF32();else if(203===t)i=this.readF64();else if(204===t)i=this.readU8();else if(205===t)i=this.readU16();else if(206===t)i=this.readU32();else if(207===t)i=this.useBigInt64?this.readU64AsBigInt():this.readU64();else if(208===t)i=this.readI8();else if(209===t)i=this.readI16();else if(210===t)i=this.readI32();else if(211===t)i=this.useBigInt64?this.readI64AsBigInt():this.readI64();else if(217===t){n=this.lookU8();i=this.decodeUtf8String(n,1)}else if(218===t){n=this.lookU16();i=this.decodeUtf8String(n,2)}else if(219===t){n=this.lookU32();i=this.decodeUtf8String(n,4)}else if(220===t){if(0!==(r=this.readU16())){this.pushArrayState(r),this.complete();continue t}i=[]}else if(221===t){if(0!==(r=this.readU32())){this.pushArrayState(r),this.complete();continue t}i=[]}else if(222===t){if(0!==(r=this.readU16())){this.pushMapState(r),this.complete();continue t}i={}}else if(223===t){if(0!==(r=this.readU32())){this.pushMapState(r),this.complete();continue t}i={}}else if(196===t){var r=this.lookU8();i=this.decodeBinary(r,1)}else if(197===t){r=this.lookU16();i=this.decodeBinary(r,2)}else if(198===t){r=this.lookU32();i=this.decodeBinary(r,4)}else if(212===t)i=this.decodeExtension(1,0);else if(213===t)i=this.decodeExtension(2,0);else if(214===t)i=this.decodeExtension(4,0);else if(215===t)i=this.decodeExtension(8,0);else if(216===t)i=this.decodeExtension(16,0);else if(199===t){r=this.lookU8();i=this.decodeExtension(r,1)}else if(200===t){r=this.lookU16();i=this.decodeExtension(r,2)}else{if(201!==t)throw new s("Unrecognized type byte: ".concat(e(t)));r=this.lookU32();i=this.decodeExtension(r,4)}this.complete();for(var o=this.stack;o.length>0;){var a=o[o.length-1];if(a.type===B){if(a.array[a.position]=i,a.position++,a.position!==a.size)continue t;o.pop(),i=a.array}else{if(a.type===_){if("string"!=typeof(h=i)&&"number"!=typeof h)throw new s("The type of key must be string or number but "+typeof i);if("__proto__"===i)throw new s("The key __proto__ is not allowed");a.key=i,a.type="map_value";continue t}if(a.map[a.key]=i,a.readCount++,a.readCount!==a.size){a.key=null,a.type=_;continue t}o.pop(),i=a.map}}return i}var h},t.prototype.readHeadByte=function(){return-1===this.headByte&&(this.headByte=this.readU8()),this.headByte},t.prototype.complete=function(){this.headByte=-1},t.prototype.readArraySize=function(){var t=this.readHeadByte();switch(t){case 220:return this.readU16();case 221:return this.readU32();default:if(t<160)return t-144;throw new s("Unrecognized array type byte: ".concat(e(t)))}},t.prototype.pushMapState=function(t){if(t>this.maxMapLength)throw new s("Max length exceeded: map length (".concat(t,") > maxMapLengthLength (").concat(this.maxMapLength,")"));this.stack.push({type:_,size:t,key:null,readCount:0,map:{}})},t.prototype.pushArrayState=function(t){if(t>this.maxArrayLength)throw new s("Max length exceeded: array length (".concat(t,") > maxArrayLength (").concat(this.maxArrayLength,")"));this.stack.push({type:B,size:t,array:new Array(t),position:0})},t.prototype.decodeUtf8String=function(t,e){var i;if(t>this.maxStrLength)throw new s("Max length exceeded: UTF-8 byte length (".concat(t,") > maxStrLength (").concat(this.maxStrLength,")"));if(this.bytes.byteLength<this.pos+e+t)throw A;var n,r=this.pos+e;return n=this.stateIsMapKey()&&(null===(i=this.keyDecoder)||void 0===i?void 0:i.canBeCached(t))?this.keyDecoder.decode(this.bytes,r,t):y(this.bytes,r,t),this.pos+=e+t,n},t.prototype.stateIsMapKey=function(){return this.stack.length>0&&this.stack[this.stack.length-1].type===_},t.prototype.decodeBinary=function(t,e){if(t>this.maxBinLength)throw new s("Max length exceeded: bin length (".concat(t,") > maxBinLength (").concat(this.maxBinLength,")"));if(!this.hasRemaining(t+e))throw A;var i=this.pos+e,n=this.bytes.subarray(i,i+t);return this.pos+=e+t,n},t.prototype.decodeExtension=function(t,e){if(t>this.maxExtLength)throw new s("Max length exceeded: ext length (".concat(t,") > maxExtLength (").concat(this.maxExtLength,")"));var i=this.view.getInt8(this.pos+e),n=this.decodeBinary(t,e+1);return this.extensionCodec.decode(n,i,this.context)},t.prototype.lookU8=function(){return this.view.getUint8(this.pos)},t.prototype.lookU16=function(){return this.view.getUint16(this.pos)},t.prototype.lookU32=function(){return this.view.getUint32(this.pos)},t.prototype.readU8=function(){var t=this.view.getUint8(this.pos);return this.pos++,t},t.prototype.readI8=function(){var t=this.view.getInt8(this.pos);return this.pos++,t},t.prototype.readU16=function(){var t=this.view.getUint16(this.pos);return this.pos+=2,t},t.prototype.readI16=function(){var t=this.view.getInt16(this.pos);return this.pos+=2,t},t.prototype.readU32=function(){var t=this.view.getUint32(this.pos);return this.pos+=4,t},t.prototype.readI32=function(){var t=this.view.getInt32(this.pos);return this.pos+=4,t},t.prototype.readU64=function(){var t,e,i=(t=this.view,e=this.pos,4294967296*t.getUint32(e)+t.getUint32(e+4));return this.pos+=8,i},t.prototype.readI64=function(){var t=h(this.view,this.pos);return this.pos+=8,t},t.prototype.readU64AsBigInt=function(){var t=this.view.getBigUint64(this.pos);return this.pos+=8,t},t.prototype.readI64AsBigInt=function(){var t=this.view.getBigInt64(this.pos);return this.pos+=8,t},t.prototype.readF32=function(){var t=this.view.getFloat32(this.pos);return this.pos+=4,t},t.prototype.readF64=function(){var t=this.view.getFloat64(this.pos);return this.pos+=8,t},t}();function P(t,e){return new T(e).decode(t)}var M=function(){function t(t){var e,i,n,r,s,o,a,h;this.extensionCodec=null!==(e=null==t?void 0:t.extensionCodec)&&void 0!==e?e:u.defaultCodec,this.context=null==t?void 0:t.context,this.useBigInt64=null!==(i=null==t?void 0:t.useBigInt64)&&void 0!==i&&i,this.maxDepth=null!==(n=null==t?void 0:t.maxDepth)&&void 0!==n?n:100,this.initialBufferSize=null!==(r=null==t?void 0:t.initialBufferSize)&&void 0!==r?r:2048,this.sortKeys=null!==(s=null==t?void 0:t.sortKeys)&&void 0!==s&&s,this.forceFloat32=null!==(o=null==t?void 0:t.forceFloat32)&&void 0!==o&&o,this.ignoreUndefined=null!==(a=null==t?void 0:t.ignoreUndefined)&&void 0!==a&&a,this.forceIntegerToFloat=null!==(h=null==t?void 0:t.forceIntegerToFloat)&&void 0!==h&&h,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return t.prototype.reinitializeState=function(){this.pos=0},t.prototype.encodeSharedRef=function(t){return this.reinitializeState(),this.doEncode(t,1),this.bytes.subarray(0,this.pos)},t.prototype.encode=function(t){return this.reinitializeState(),this.doEncode(t,1),this.bytes.slice(0,this.pos)},t.prototype.doEncode=function(t,e){if(e>this.maxDepth)throw new Error("Too deep objects in depth ".concat(e));null==t?this.encodeNil():"boolean"==typeof t?this.encodeBoolean(t):"number"==typeof t?this.forceIntegerToFloat?this.encodeNumberAsFloat(t):this.encodeNumber(t):"string"==typeof t?this.encodeString(t):this.useBigInt64&&"bigint"==typeof t?this.encodeBigInt64(t):this.encodeObject(t,e)},t.prototype.ensureBufferSizeToWrite=function(t){var e=this.pos+t;this.view.byteLength<e&&this.resizeBuffer(2*e)},t.prototype.resizeBuffer=function(t){var e=new ArrayBuffer(t),i=new Uint8Array(e),n=new DataView(e);i.set(this.bytes),this.view=n,this.bytes=i},t.prototype.encodeNil=function(){this.writeU8(192)},t.prototype.encodeBoolean=function(t){!1===t?this.writeU8(194):this.writeU8(195)},t.prototype.encodeNumber=function(t){!this.forceIntegerToFloat&&Number.isSafeInteger(t)?t>=0?t<128?this.writeU8(t):t<256?(this.writeU8(204),this.writeU8(t)):t<65536?(this.writeU8(205),this.writeU16(t)):t<4294967296?(this.writeU8(206),this.writeU32(t)):this.useBigInt64?this.encodeNumberAsFloat(t):(this.writeU8(207),this.writeU64(t)):t>=-32?this.writeU8(224|t+32):t>=-128?(this.writeU8(208),this.writeI8(t)):t>=-32768?(this.writeU8(209),this.writeI16(t)):t>=-2147483648?(this.writeU8(210),this.writeI32(t)):this.useBigInt64?this.encodeNumberAsFloat(t):(this.writeU8(211),this.writeI64(t)):this.encodeNumberAsFloat(t)},t.prototype.encodeNumberAsFloat=function(t){this.forceFloat32?(this.writeU8(202),this.writeF32(t)):(this.writeU8(203),this.writeF64(t))},t.prototype.encodeBigInt64=function(t){t>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(t)):(this.writeU8(211),this.writeBigInt64(t))},t.prototype.writeStringHeader=function(t){if(t<32)this.writeU8(160+t);else if(t<256)this.writeU8(217),this.writeU8(t);else if(t<65536)this.writeU8(218),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too long string: ".concat(t," bytes in UTF-8"));this.writeU8(219),this.writeU32(t)}},t.prototype.encodeString=function(t){var e=function(t){for(var e=t.length,i=0,n=0;n<e;){var r=t.charCodeAt(n++);if(4294967168&r)if(4294965248&r){if(r>=55296&&r<=56319&&n<e){var s=t.charCodeAt(n);56320==(64512&s)&&(++n,r=((1023&r)<<10)+(1023&s)+65536)}i+=4294901760&r?4:3}else i+=2;else i++}return i}(t);this.ensureBufferSizeToWrite(5+e),this.writeStringHeader(e),f(t,this.bytes,this.pos),this.pos+=e},t.prototype.encodeObject=function(t,e){var i=this.extensionCodec.tryToEncode(t,this.context);if(null!=i)this.encodeExtension(i);else if(Array.isArray(t))this.encodeArray(t,e);else if(ArrayBuffer.isView(t))this.encodeBinary(t);else{if("object"!=typeof t)throw new Error("Unrecognized object: ".concat(Object.prototype.toString.apply(t)));this.encodeMap(t,e)}},t.prototype.encodeBinary=function(t){var e=t.byteLength;if(e<256)this.writeU8(196),this.writeU8(e);else if(e<65536)this.writeU8(197),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too large binary: ".concat(e));this.writeU8(198),this.writeU32(e)}var i=w(t);this.writeU8a(i)},t.prototype.encodeArray=function(t,e){var i=t.length;if(i<16)this.writeU8(144+i);else if(i<65536)this.writeU8(220),this.writeU16(i);else{if(!(i<4294967296))throw new Error("Too large array: ".concat(i));this.writeU8(221),this.writeU32(i)}for(var n=0,r=t;n<r.length;n++){var s=r[n];this.doEncode(s,e+1)}},t.prototype.countWithoutUndefined=function(t,e){for(var i=0,n=0,r=e;n<r.length;n++){void 0!==t[r[n]]&&i++}return i},t.prototype.encodeMap=function(t,e){var i=Object.keys(t);this.sortKeys&&i.sort();var n=this.ignoreUndefined?this.countWithoutUndefined(t,i):i.length;if(n<16)this.writeU8(128+n);else if(n<65536)this.writeU8(222),this.writeU16(n);else{if(!(n<4294967296))throw new Error("Too large map object: ".concat(n));this.writeU8(223),this.writeU32(n)}for(var r=0,s=i;r<s.length;r++){var o=s[r],a=t[o];this.ignoreUndefined&&void 0===a||(this.encodeString(o),this.doEncode(a,e+1))}},t.prototype.encodeExtension=function(t){var e=t.data.length;if(1===e)this.writeU8(212);else if(2===e)this.writeU8(213);else if(4===e)this.writeU8(214);else if(8===e)this.writeU8(215);else if(16===e)this.writeU8(216);else if(e<256)this.writeU8(199),this.writeU8(e);else if(e<65536)this.writeU8(200),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too large extension object: ".concat(e));this.writeU8(201),this.writeU32(e)}this.writeI8(t.type),this.writeU8a(t.data)},t.prototype.writeU8=function(t){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,t),this.pos++},t.prototype.writeU8a=function(t){var e=t.length;this.ensureBufferSizeToWrite(e),this.bytes.set(t,this.pos),this.pos+=e},t.prototype.writeI8=function(t){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,t),this.pos++},t.prototype.writeU16=function(t){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,t),this.pos+=2},t.prototype.writeI16=function(t){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,t),this.pos+=2},t.prototype.writeU32=function(t){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,t),this.pos+=4},t.prototype.writeI32=function(t){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,t),this.pos+=4},t.prototype.writeF32=function(t){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,t),this.pos+=4},t.prototype.writeF64=function(t){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,t),this.pos+=8},t.prototype.writeU64=function(t){this.ensureBufferSizeToWrite(8),function(t,e,i){var n=i/4294967296,r=i;t.setUint32(e,n),t.setUint32(e+4,r)}(this.view,this.pos,t),this.pos+=8},t.prototype.writeI64=function(t){this.ensureBufferSizeToWrite(8),a(this.view,this.pos,t),this.pos+=8},t.prototype.writeBigUint64=function(t){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,t),this.pos+=8},t.prototype.writeBigInt64=function(t){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,t),this.pos+=8},t}();function L(t,e){return new M(e).encodeSharedRef(t)}class z{static _decoder=new TextDecoder;_data=new Uint8Array;reset(t){this._data=new Uint8Array(t)}bytes(){return new Uint8Array(this._data)}size(){return this._data.length}empty(){return this.size()<1}getByte(){if(this.size()<1)throw new Error("not enough data to read a byte");const t=this._data[0];return this._data=this._data.slice(1),t}getBytes(t){if(this.size()<t)throw new Error("not enough data to read bytes");const e=this._data.slice(0,t);return this._data=this._data.slice(t),e}getString(){const t=this.getByte(),e=this.getBytes(t);return z._decoder.decode(e)}getValue(){const t=this.getByte();return P(this.getBytes(t))}}class R{static _encoder=new TextEncoder;_buf=new Uint8Array(1024);_pos=0;reset(){this._pos=0}bytes(){return this._buf.slice(0,this._pos)}left(){return this._buf.length-this._pos}size(){return this._pos}putByte(t){if(this.left()<1)throw new Error("not enough space to write a byte");this._buf[this._pos++]=t}putBytes(t){const e=t.length;if(this.left()<e)throw new Error("not enough space to write bytes");this._buf.set(t,this._pos),this._pos+=e}putString(t){const e=R._encoder.encode(t);this.putByte(e.length),this.putBytes(e)}putValue(t){const e=L(t);this.putByte(e.length),this.putBytes(e)}}class D{_callbacks=new Map;_ws;connect(t,e){const i=new WebSocket(`${t}/api/game/start?token=${e}`);i.binaryType="arraybuffer",i.onopen=this.cbOpen.bind(this,i),i.onclose=this.cbClose.bind(this),i.onerror=this.cbError.bind(this),i.onmessage=this.cbMessage.bind(this)}isReady(){return!!this._ws}uniqueKey(){let t;do{t=Math.random()}while(this._callbacks.has(t));return t}resolveResult(t){t instanceof Promise&&t.catch(console.error)}cbOpen(t){this._ws=t,this.resolveResult(this.onOpen())}cbClose(t){this._ws=void 0,this.resolveResult(this.onClose(t.reason))}cbError(t){console.error(t),this.resolveResult(this.onError())}cbMessage(t){try{const e=new z;switch(e.reset(new Uint8Array(t.data)),e.getByte()){case 0:return this.cbPong(e);case 1:return this.cbResp(e);case 2:return this.cbRecv(e);default:throw new Error}}catch(t){console.error(t)}}cbPong(t){const e=t.getValue(),i=Date.now()-e;this.resolveResult(this.onPong(i))}cbResp(t){const e=t.getValue(),i=this._callbacks.get(e);if(this._callbacks.delete(e),i)try{const e={};for(;!t.empty();){const i=t.getString(),n=t.getValue();e[i]=n}this.resolveResult(i(e))}catch(t){console.error(t),this.resolveResult(i({}))}}cbRecv(t){const e=t.getString(),i=t.getString(),n=t.getString();try{const r=t.size()>0?P(t.bytes()):[];if(!Array.isArray(r))return void console.error(`invalid recv packet from ${i}`);this.resolveResult(this.onRecv(e,i,n,r))}catch(t){console.error(t)}}send(t){if(!this._ws)throw new Error("network not started");this._ws.send(t)}ping(){const t=new R;t.putByte(0),t.putValue(Date.now()),this.send(t.bytes())}load(t,e,i){const n=this.uniqueKey(),r=new R;r.putByte(1),r.putByte(t?1:0),r.putString(e),r.putValue(n),this._callbacks.set(n,i),this.send(r.bytes())}loadAsync(t,e){return new Promise((i=>{this.load(t,e,i)}))}save(t,e,i){const n=new R;n.putByte(2),n.putByte(t?1:0),n.putString(e);for(const t in i){const e=i[t];n.putString(t),n.putValue(e)}this.send(n.bytes())}subscribe(t,e,...i){const n=new R;n.putByte(3),n.putString(t),n.putString(e||""),n.putBytes(L(i)),this.send(n.bytes())}broadcast(t,e,...i){const n=new R;n.putByte(4),n.putByte(t?1:0),n.putString(e),n.putBytes(L(i)),this.send(n.bytes())}publish(t,e,i,...n){const r=new R;r.putByte(5),r.putByte(t?1:0),r.putString(e),r.putString(i),r.putBytes(L(n)),this.send(r.bytes())}sendto(t,e,...i){const n=new R;n.putByte(6),n.putString(t),n.putString(e),n.putBytes(L(i)),this.send(n.bytes())}report(t,e){const i=new R;i.putByte(9),i.putString(t),i.putString(e),this.send(i.bytes())}}class C extends Error{}function F(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return function(t){return decodeURIComponent(atob(t).replace(/(.)/g,((t,e)=>{let i=e.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i})))}(e)}catch(t){return atob(e)}}function O(t){return function(t,e){if("string"!=typeof t)throw new C("Invalid token specified: must be a string");e||(e={});const i=!0===e.header?0:1,n=t.split(".")[i];if("string"!=typeof n)throw new C(`Invalid token specified: missing part #${i+1}`);let r;try{r=F(n)}catch(t){throw new C(`Invalid token specified: invalid base64 for part #${i+1} (${t.message})`)}try{return JSON.parse(r)}catch(t){throw new C(`Invalid token specified: invalid json for part #${i+1} (${t.message})`)}}(t)}C.prototype.name="InvalidTokenError";class ${_values=new Array;_funcs=new Map;tryFuncs(t){return this._funcs.get(t)}reqFuncs(t){let e=this._funcs.get(t);return e||(e=[],this._funcs.set(t,e)),e}addValue(t,e){this._values.push([t,e])}addFunc(t,e){this.reqFuncs(t).push(e)}next(){return this._values.shift()}}const V=function(...t){},W={FB3D175F:"Another user logged in this account","41B6348E":"Invalid Packet"};const K=t.Scene_Base.prototype.isReady;t.Scene_Base.prototype.isReady=function(){return K.call(this)&&window.client.isReady()};const N=t.Scene_Base.prototype.update;t.Scene_Base.prototype.update=function(){window.client.update(),N.call(this)},t.Scene_Base.prototype.isAutosaveEnabled=function(){return!1},t.Scene_Title.prototype.create=function(){t.Scene_Base.prototype.create.call(this)},t.Scene_Title.prototype.start=function(){t.Scene_Base.prototype.start.call(this),t.SceneManager.clearStack(),t.DataManager.setupNewGame();const e=window.client.toload();this._loading=e.length;for(const[t,i,n]of e)V("*",t,i),window.client.load(t,i,(async e=>{V("&",t,i,e);let r=n(e);for(;r instanceof Promise;)r=await r;this.cbLoad()}))},t.Scene_Title.prototype.isBusy=function(){return t.Scene_Base.prototype.isBusy.call(this)},t.Scene_Title.prototype.update=function(){t.Scene_Base.prototype.update.call(this)},t.Scene_Title.prototype.cbLoad=function(){if(this._loading-=1,!(this._loading>0)){if(V("starting game"),t.$gameParty.isAllDead()||!t.$gamePlayer.isTransferring()){V("revive");const e=t.$dataSystem.startMapId,i=t.$dataSystem.startX,n=t.$dataSystem.startY;t.$gamePlayer.reserveTransfer(e,i,n,2,0),t.$gameParty.leader().recoverAll()}t.SceneManager.goto(t.Scene_Map)}},window.client=new class extends D{_toload=new Array;_msgs=new $;_token="";_user="";_ping;_error=!1;constructor(){super();const e=localStorage.getItem("WS_TOKEN");if(!e)return V("token invalid, redirecting"),void this.retry(!0);this._token=e;const i=O(this._token),n=i.sub;if(!n)return V("token user invalid, redirecting"),void this.retry(!0);if(this._user=n,!i.exp||i.exp<Date.now()/1e3)return V("token expired, redirecting"),void this.retry(!0);const r=t.PluginManager.parameters("MMORPG_Client");if(!r)throw new Error("invalid server parameters");const{ssl:s,address:o}=r;this.connect(`${"true"==s?"wss":"ws"}://${o}`,this._token)}user(){return this._user}getPing(){return this._ping?Math.round(this._ping):null}logout(){var t;(t=void 0)?localStorage.setItem("WS_TOKEN",t):localStorage.removeItem("WS_TOKEN"),this.retry(!0)}retry(t){t?location.href="login.html":location.reload()}onOpen(){V("OPEN"),this.setPingTimeout()}onClose(t){V("CLOSE",t);const e=t?W[t]:null;e&&alert(e),this.retry(this._error||!!t)}onError(){V("ERROR"),this._error=!0,this.retry(!0)}save(t,e,i){V("<","save",t,e,i),super.save(t,e,i)}load(t,e,i){V("<","load",t,e),super.load(t,e,(n=>{V(">","load",t,e,n),i(n)}))}subscribe(t,e,...i){V("<","subscribe",t,e,...i),super.subscribe(t,e,...i)}broadcast(t,e,...i){this.unsafeBroadcast(t,e,...i)}publish(t,e,i,...n){this.unsafePublish(t,e,i,...n)}sendto(t,e,...i){this.unsafeSendto(t,e,...i)}report(t,e){V("<","report",t,e),super.report(t,e)}onPingTimeout(){this.isReady()?this.ping():this.setPingTimeout()}setPingTimeout(){setTimeout((()=>this.onPingTimeout()),2e3)}onPong(e){try{this._ping?this._ping=(this._ping+e)/2:this._ping=e;const i=t.$dataSystem?.gameTitle;i&&(document.title=`${i} (${this.getPing()} ms)`)}finally{this.setPingTimeout()}}makeKey(t,e){return JSON.stringify([t,e])}onRecv(t,e,i,n){V(">","recv",t,e,i,...n),this._msgs.addValue(this.makeKey(t,i),[e,n])}start(t,e,i){this._toload.push([t,e,i])}react(t,e,i,n){this.unsafeReact(t,e,i,n)}safeBroadcast(t,e,i,n){const r=t.safeParse(n);r.success?this.unsafeBroadcast(e,i,n):console.error(r.error)}safePublish(t,e,i,n,r){const s=t.safeParse(r);s.success?this.unsafePublish(e,i,n,r):console.error(s.error)}safeSendto(t,e,i,n){const r=t.safeParse(n);r.success?this.unsafeSendto(e,i,n):console.error(r.error)}safeReact(t,e,i,n,r){this.unsafeReact(t,i,n,((t,s,o)=>{const a=e.safeParse(o);a.success?r(t,s,a.data):(console.error(a.error),this.report(s,`sent invalid type: ${i}, ${n}`))}))}toload(){return Array.from(this._toload)}unsafeBroadcast(t,e,...i){V("<","broadcast",t,e,...i),super.broadcast(t,e,...i)}unsafePublish(t,e,i,...n){V("<","publish",t,e,i,...n),super.publish(t,e,i,...n)}unsafeSendto(t,e,...i){V("<","sendto",t,e,...i),super.sendto(t,e,...i)}unsafeReact(e,i,n,r){const s=Array.isArray(i)?i:[i];for(const i of s)this._msgs.addFunc(this.makeKey(i,n),(s=>{const[o,a]=s,h=t.SceneManager._scene;if(!(h instanceof e))return;V("$",e.name,i,o,n,...a);const c=r(h,o,...a);c instanceof Promise&&c.catch(console.error)}))}updateCallbacks(t){let e;for(;e=t.next();){const[i,n]=e,r=t.tryFuncs(i);if(r)for(const t of r)try{t(n)}catch(t){console.error(t)}else V("unhandled:",i,n)}}update(){this.updateCallbacks(this._msgs)}},t.SceneManager.isGameActive=function(){return!0},t.Window_MenuCommand.prototype.isSaveEnabled=function(){return!1},t.Game_Interpreter.prototype.command354=function(){return window.client.logout(),!0},t.Scene_GameEnd.prototype.commandToTitle=function(){this.fadeOutAll(),window.client.logout()},t.StorageManager.isLocalMode=function(){return!1},t.DataManager.isTitleSkip=function(){return!1}})();